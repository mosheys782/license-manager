<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Producer License Manager</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%); min-height: 100vh; }
    input, select, textarea, button { font-family: inherit; }
    #root { min-height: 100vh; }
  </style>
</head>
<body>
  <div id="root">
    <div style="display:flex;align-items:center;justify-content:center;height:100vh;font-size:18px;">Loading...</div>
  </div>
  
  <script type="text/babel" data-presets="react">
    const { useState, useEffect, useMemo, useCallback } = React;

    // ============ CONFIGURATION ============
    const CONFIG = {
      clientId: 'd664bcd7-83b4-4b23-9c97-e250efe46bfa',
      tenantId: '8b20613e-54c4-43a3-af63-92cdbf260edb',
      siteHostname: 'gancfried.sharepoint.com',
      sitePath: '/sites/GIBUSA',
      listName: 'ProducerLicenses',
      documentLibrary: 'LicenseDocuments',
      redirectUri: 'https://licenses.gibusa.com/'
    };

    // Company Logos (will be loaded from GitHub)
    const LOGO_FULL = 'GIB_logo_full_blue.png';
    const LOGO_ICON = 'GIB_icon_light.png';

    // MSAL Configuration
    const msalConfig = {
      auth: {
        clientId: CONFIG.clientId,
        authority: `https://login.microsoftonline.com/${CONFIG.tenantId}`,
        redirectUri: CONFIG.redirectUri,
      },
      cache: {
        cacheLocation: 'localStorage',
        storeAuthStateInCookie: false,
      }
    };

    const msalInstance = new msal.PublicClientApplication(msalConfig);

    const loginRequest = {
      scopes: ['User.Read', 'Sites.ReadWrite.All']
    };

    // ============ CONSTANTS ============
    const US_STATES = [
      'Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California', 'Colorado', 'Connecticut', 'Delaware',
      'Florida', 'Georgia', 'Hawaii', 'Idaho', 'Illinois', 'Indiana', 'Iowa', 'Kansas', 'Kentucky',
      'Louisiana', 'Maine', 'Maryland', 'Massachusetts', 'Michigan', 'Minnesota', 'Mississippi',
      'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire', 'New Jersey', 'New Mexico',
      'New York', 'North Carolina', 'North Dakota', 'Ohio', 'Oklahoma', 'Oregon', 'Pennsylvania',
      'Rhode Island', 'South Carolina', 'South Dakota', 'Tennessee', 'Texas', 'Utah', 'Vermont',
      'Virginia', 'Washington', 'West Virginia', 'Wisconsin', 'Wyoming', 'District of Columbia'
    ];

    const LICENSE_TYPES = [
      'Life', 'Health', 'Property', 'Casualty', 'Life & Health', 'Property & Casualty',
      'Personal Lines', 'Variable Life/Annuity', 'Surplus Lines', 'Title', 'Bail Bonds'
    ];

    // ============ UTILITY FUNCTIONS ============
    const calculateDaysUntilExpiration = (expirationDate) => {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const expDate = new Date(expirationDate);
      expDate.setHours(0, 0, 0, 0);
      return Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
    };

    const getStatus = (expirationDate) => {
      const days = calculateDaysUntilExpiration(expirationDate);
      if (days < 0) return 'expired';
      if (days <= 30) return 'expiring';
      return 'active';
    };

    const formatDate = (dateString) => {
      if (!dateString) return '';
      return new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    };

    const formatDateForInput = (dateString) => {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toISOString().split('T')[0];
    };

    // ============ SHAREPOINT SERVICE ============
    class SharePointService {
      constructor() {
        this.siteId = null;
        this.listId = null;
        this.driveId = null;
      }

      async getAccessToken() {
        const accounts = msalInstance.getAllAccounts();
        if (accounts.length === 0) {
          throw new Error('No authenticated user');
        }
        
        try {
          const response = await msalInstance.acquireTokenSilent({
            ...loginRequest,
            account: accounts[0]
          });
          return response.accessToken;
        } catch (error) {
          const response = await msalInstance.acquireTokenPopup(loginRequest);
          return response.accessToken;
        }
      }

      async graphRequest(endpoint, options = {}) {
        const token = await this.getAccessToken();
        const response = await fetch(`https://graph.microsoft.com/v1.0${endpoint}`, {
          ...options,
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            ...options.headers
          }
        });
        
        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          console.error('SharePoint API Error:', error);
          const errorMsg = error.error?.message || error.error?.code || `HTTP ${response.status}`;
          throw new Error(errorMsg);
        }
        
        if (response.status === 204) return null;
        return response.json();
      }

      async initialize() {
        // Get site ID
        const sitePath = CONFIG.sitePath ? `:${CONFIG.sitePath}:` : '';
        const siteResponse = await this.graphRequest(`/sites/${CONFIG.siteHostname}${sitePath}`);
        this.siteId = siteResponse.id;

        // Get list ID
        const listsResponse = await this.graphRequest(`/sites/${this.siteId}/lists?$filter=displayName eq '${CONFIG.listName}'`);
        if (listsResponse.value.length === 0) {
          throw new Error(`List "${CONFIG.listName}" not found`);
        }
        this.listId = listsResponse.value[0].id;

        // Get drive ID for document library
        try {
          const drivesResponse = await this.graphRequest(`/sites/${this.siteId}/drives`);
          const docLibDrive = drivesResponse.value.find(d => d.name === CONFIG.documentLibrary);
          if (docLibDrive) {
            this.driveId = docLibDrive.id;
          }
        } catch (err) {
          console.warn('Could not find document library:', err);
        }
      }

      // Upload document to SharePoint Document Library
      async uploadDocument(fileName, base64Data) {
        if (!this.siteId) {
          await this.initialize();
        }

        if (!this.driveId) {
          throw new Error(`Document library "${CONFIG.documentLibrary}" not found. Please create it in SharePoint.`);
        }

        // Convert base64 to binary
        const base64Content = base64Data.split(',')[1]; // Remove data:application/pdf;base64, prefix
        const binaryString = atob(base64Content);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }

        // Generate unique filename
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const uniqueFileName = `${timestamp}_${fileName}`;

        // Upload file
        const token = await this.getAccessToken();
        const uploadResponse = await fetch(
          `https://graph.microsoft.com/v1.0/drives/${this.driveId}/root:/${uniqueFileName}:/content`,
          {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/pdf'
            },
            body: bytes
          }
        );

        if (!uploadResponse.ok) {
          const error = await uploadResponse.json().catch(() => ({}));
          throw new Error(error.error?.message || 'Failed to upload document');
        }

        const fileData = await uploadResponse.json();
        
        // Return the web URL for viewing
        return {
          url: fileData.webUrl,
          name: uniqueFileName,
          downloadUrl: fileData['@microsoft.graph.downloadUrl']
        };
      }

      // Get file content for viewing in iframe
      async getFileForViewing(webUrl) {
        if (!this.siteId) {
          await this.initialize();
        }

        try {
          // Extract filename from URL
          const urlParts = webUrl.split('/');
          const fileName = decodeURIComponent(urlParts[urlParts.length - 1]);
          
          // Get file info from drive to get download URL
          const token = await this.getAccessToken();
          const response = await fetch(
            `https://graph.microsoft.com/v1.0/drives/${this.driveId}/root:/${fileName}`,
            {
              headers: { 'Authorization': `Bearer ${token}` }
            }
          );

          if (!response.ok) {
            throw new Error('Could not get file info');
          }

          const fileInfo = await response.json();
          const downloadUrl = fileInfo['@microsoft.graph.downloadUrl'];

          if (downloadUrl) {
            // Fetch the actual file content
            const fileResponse = await fetch(downloadUrl);
            const blob = await fileResponse.blob();
            return URL.createObjectURL(blob);
          }
          
          throw new Error('No download URL available');
        } catch (err) {
          console.error('Error getting file for viewing:', err);
          return null;
        }
      }

      async getLicenses() {
        if (!this.siteId || !this.listId) {
          await this.initialize();
        }

        const response = await this.graphRequest(
          `/sites/${this.siteId}/lists/${this.listId}/items?$expand=fields&$top=500`
        );

        return response.value.map(item => ({
          id: item.id,
          type: item.fields.LicenseType || 'individual',
          name: item.fields.ProducerName || item.fields.Title || '',
          npn: item.fields.NPN || '',
          fein: item.fields.FEIN || '',
          state: item.fields.State || '',
          licenseType: item.fields.LicenseCategory || '',
          licenseNumber: item.fields.LicenseNumber || '',
          effectiveDate: item.fields.EffectiveDate ? formatDateForInput(item.fields.EffectiveDate) : '',
          expirationDate: item.fields.ExpirationDate ? formatDateForInput(item.fields.ExpirationDate) : '',
          emailReminders: item.fields.EmailReminders !== false,
          renewed: item.fields.Renewed || false,
          notes: item.fields.Notes || '',
          documents: item.fields.DocumentUrl ? [{ name: item.fields.DocumentName || 'License Document', url: item.fields.DocumentUrl }] : []
        }));
      }

      async createLicense(license) {
        if (!this.siteId || !this.listId) {
          await this.initialize();
        }

        // Upload document if present (check for base64 data)
        let documentUrl = '';
        let documentName = '';
        
        if (license.documents && license.documents.length > 0) {
          const doc = license.documents[0];
          // Check if it's base64 data (new upload) vs existing URL
          if (doc.data && doc.data.startsWith('data:')) {
            console.log('Uploading document to SharePoint...');
            const uploadResult = await this.uploadDocument(doc.name, doc.data);
            documentUrl = uploadResult.url;
            documentName = uploadResult.name;
            console.log('Document uploaded:', documentUrl);
          } else if (doc.url) {
            // Existing URL
            documentUrl = doc.url;
            documentName = doc.name;
          }
        }

        const fields = {
          Title: license.name,
          ProducerName: license.name,
          LicenseType: license.type,
          NPN: license.npn || '',
          FEIN: license.fein || '',
          State: license.state,
          LicenseCategory: license.licenseType,
          LicenseNumber: license.licenseNumber,
          EffectiveDate: license.effectiveDate || null,
          ExpirationDate: license.expirationDate || null,
          EmailReminders: license.emailReminders,
          Renewed: license.renewed || false,
          Notes: license.notes || '',
          DocumentUrl: documentUrl,
          DocumentName: documentName
        };
        
        console.log('Creating license with fields:', fields);

        const response = await this.graphRequest(
          `/sites/${this.siteId}/lists/${this.listId}/items`,
          {
            method: 'POST',
            body: JSON.stringify({ fields })
          }
        );

        return {
          ...license,
          id: response.id,
          documents: documentUrl ? [{ name: documentName, url: documentUrl }] : []
        };
      }

      async updateLicense(license) {
        if (!this.siteId || !this.listId) {
          await this.initialize();
        }

        // Upload document if present (check for base64 data)
        let documentUrl = '';
        let documentName = '';
        
        if (license.documents && license.documents.length > 0) {
          const doc = license.documents[0];
          // Check if it's base64 data (new upload) vs existing URL
          if (doc.data && doc.data.startsWith('data:')) {
            console.log('Uploading document to SharePoint...');
            const uploadResult = await this.uploadDocument(doc.name, doc.data);
            documentUrl = uploadResult.url;
            documentName = uploadResult.name;
            console.log('Document uploaded:', documentUrl);
          } else if (doc.url) {
            // Existing URL
            documentUrl = doc.url;
            documentName = doc.name;
          }
        }

        const fields = {
          Title: license.name,
          ProducerName: license.name,
          LicenseType: license.type,
          NPN: license.npn || '',
          FEIN: license.fein || '',
          State: license.state,
          LicenseCategory: license.licenseType,
          LicenseNumber: license.licenseNumber,
          EffectiveDate: license.effectiveDate || null,
          ExpirationDate: license.expirationDate || null,
          EmailReminders: license.emailReminders,
          Renewed: license.renewed || false,
          Notes: license.notes || '',
          DocumentUrl: documentUrl,
          DocumentName: documentName
        };

        console.log('Updating license with fields:', fields);

        await this.graphRequest(
          `/sites/${this.siteId}/lists/${this.listId}/items/${license.id}/fields`,
          {
            method: 'PATCH',
            body: JSON.stringify(fields)
          }
        );

        return {
          ...license,
          documents: documentUrl ? [{ name: documentName, url: documentUrl }] : []
        };
      }

      async deleteLicense(id) {
        if (!this.siteId || !this.listId) {
          await this.initialize();
        }

        await this.graphRequest(
          `/sites/${this.siteId}/lists/${this.listId}/items/${id}`,
          { method: 'DELETE' }
        );
      }
    }

    const spService = new SharePointService();

    // ============ UI COMPONENTS ============
    const StatusBadge = ({ status }) => {
      const styles = {
        active: { background: 'linear-gradient(135deg, #059669 0%, #10b981 100%)', color: 'white' },
        expiring: { background: 'linear-gradient(135deg, #d97706 0%, #f59e0b 100%)', color: 'white' },
        expired: { background: 'linear-gradient(135deg, #dc2626 0%, #ef4444 100%)', color: 'white' },
        renewed: { background: 'linear-gradient(135deg, #2563eb 0%, #3b82f6 100%)', color: 'white' }
      };
      const labels = { active: 'Active', expiring: 'Expiring Soon', expired: 'Expired', renewed: 'Renewed' };
      return React.createElement('span', { style: { ...styles[status], padding: '4px 12px', borderRadius: '20px', fontSize: '11px', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.5px', display: 'inline-block' } }, labels[status]);
    };

    const Button = ({ children, variant = 'primary', onClick, disabled, style = {} }) => {
      const variants = {
        primary: { background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', color: 'white', border: 'none' },
        secondary: { background: 'white', color: '#374151', border: '1px solid #d1d5db' },
        success: { background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', color: 'white', border: 'none' },
        danger: { background: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)', color: 'white', border: 'none' }
      };
      return React.createElement('button', {
        onClick, disabled,
        style: { ...variants[variant], padding: '10px 20px', borderRadius: '8px', fontSize: '14px', fontWeight: '600', cursor: disabled ? 'not-allowed' : 'pointer', opacity: disabled ? 0.6 : 1, transition: 'all 0.2s', ...style }
      }, children);
    };

    const Modal = ({ isOpen, onClose, title, children, size }) => {
      if (!isOpen) return null;
      const widths = { small: '400px', medium: '600px', large: '900px' };
      return React.createElement('div', { 
        style: { position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.6)', backdropFilter: 'blur(4px)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }, 
        onClick: onClose 
      },
        React.createElement('div', { 
          style: { background: 'white', borderRadius: '16px', width: '100%', maxWidth: widths[size || 'medium'], maxHeight: '90vh', overflow: 'auto', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)' }, 
          onClick: (e) => e.stopPropagation() 
        },
          React.createElement('div', { style: { padding: '20px 24px', borderBottom: '1px solid #e5e7eb', display: 'flex', justifyContent: 'space-between', alignItems: 'center', position: 'sticky', top: 0, background: 'white', borderRadius: '16px 16px 0 0' } },
            React.createElement('h2', { style: { margin: 0, fontSize: '18px', fontWeight: '600', color: '#111827' } }, title),
            React.createElement('button', { onClick: onClose, style: { background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: '#6b7280', lineHeight: 1 } }, 'Ã—')
          ),
          React.createElement('div', { style: { padding: '24px' } }, children)
        )
      );
    };

    const FormInput = ({ label, required, type, value, onChange, placeholder, children, min, max }) => {
      return React.createElement('div', { style: { marginBottom: '16px' } },
        React.createElement('label', { style: { display: 'block', marginBottom: '6px', fontWeight: '500', fontSize: '14px', color: '#374151' } },
          label, required && React.createElement('span', { style: { color: '#ef4444' } }, ' *')
        ),
        type === 'select'
          ? React.createElement('select', { value, onChange: (e) => onChange(e.target.value), style: { width: '100%', padding: '10px 12px', border: '1px solid #d1d5db', borderRadius: '8px', fontSize: '14px', background: 'white' } }, children)
          : type === 'textarea'
            ? React.createElement('textarea', { value, onChange: (e) => onChange(e.target.value), placeholder, style: { width: '100%', padding: '10px 12px', border: '1px solid #d1d5db', borderRadius: '8px', fontSize: '14px', minHeight: '80px', resize: 'vertical' } })
            : React.createElement('input', { type: type || 'text', value, onChange: (e) => onChange(e.target.value), placeholder, min, max, style: { width: '100%', padding: '10px 12px', border: '1px solid #d1d5db', borderRadius: '8px', fontSize: '14px' } })
      );
    };

    // ============ DEFAULT VALUES ============
    const DEFAULTS = {
      individual: {
        name: 'Chaim Gancfried',
        npn: '6360803'
      },
      business: {
        name: 'Gancfried Insurance Brokerage Inc',
        npn: '7382926',
        fein: '11-3471664'
      }
    };

    // ============ LICENSE FORM ============
    const LicenseForm = ({ license, onSave, onCancel, saving }) => {
      const getInitialForm = () => {
        if (license) return license;
        return {
          type: 'individual',
          name: DEFAULTS.individual.name,
          npn: DEFAULTS.individual.npn,
          fein: '',
          state: '',
          licenseType: 'Property & Casualty',
          licenseNumber: '',
          effectiveDate: '',
          expirationDate: '',
          emailReminders: true,
          renewed: false,
          notes: '',
          documents: []
        };
      };

      const [form, setForm] = useState(getInitialForm());

      const updateField = (field, value) => setForm(prev => ({ ...prev, [field]: value }));

      // Handle type change - apply defaults
      const handleTypeChange = (newType) => {
        if (license) {
          // If editing, just change type
          updateField('type', newType);
        } else {
          // If new license, apply defaults for that type
          if (newType === 'individual') {
            setForm(prev => ({
              ...prev,
              type: 'individual',
              name: DEFAULTS.individual.name,
              npn: DEFAULTS.individual.npn,
              fein: ''
            }));
          } else {
            setForm(prev => ({
              ...prev,
              type: 'business',
              name: DEFAULTS.business.name,
              npn: DEFAULTS.business.npn,
              fein: DEFAULTS.business.fein
            }));
          }
        }
      };

      const handleFileUpload = (e) => {
        const file = e.target.files ? e.target.files[0] : null;
        processFile(file);
      };

      const processFile = (file) => {
        if (file && file.type === 'application/pdf') {
          const reader = new FileReader();
          reader.onload = (event) => {
            setForm(prev => ({
              ...prev,
              documents: [{ name: file.name, data: event.target.result, type: file.type }]
            }));
          };
          reader.readAsDataURL(file);
        } else if (file) {
          alert('Please upload a PDF file');
        }
      };

      const handleDragOver = (e) => {
        e.preventDefault();
        e.stopPropagation();
      };

      const handleDrop = (e) => {
        e.preventDefault();
        e.stopPropagation();
        const file = e.dataTransfer.files[0];
        processFile(file);
      };

      const removeDocument = () => {
        setForm(prev => ({ ...prev, documents: [] }));
      };

      const handleSubmit = () => {
        if (!form.name || !form.state || !form.licenseType || !form.licenseNumber || !form.expirationDate) {
          alert('Please fill in all required fields');
          return;
        }
        onSave(form);
      };

      return React.createElement('div', null,
        React.createElement('div', { style: { marginBottom: '20px' } },
          React.createElement('label', { style: { display: 'block', marginBottom: '8px', fontWeight: '500' } }, 'License Type'),
          React.createElement('div', { style: { display: 'flex', gap: '12px' } },
            ['individual', 'business'].map(type =>
              React.createElement('label', { key: type, style: { flex: 1, padding: '16px', border: `2px solid ${form.type === type ? '#3b82f6' : '#e5e7eb'}`, borderRadius: '12px', cursor: 'pointer', background: form.type === type ? '#eff6ff' : 'white', display: 'flex', alignItems: 'center', gap: '10px' } },
                React.createElement('input', { type: 'radio', name: 'type', checked: form.type === type, onChange: () => handleTypeChange(type), style: { display: 'none' } }),
                React.createElement('span', { style: { width: '20px', height: '20px', borderRadius: '50%', border: `2px solid ${form.type === type ? '#3b82f6' : '#d1d5db'}`, display: 'flex', alignItems: 'center', justifyContent: 'center' } },
                  form.type === type && React.createElement('span', { style: { width: '10px', height: '10px', borderRadius: '50%', background: '#3b82f6' } })
                ),
                React.createElement('span', { style: { fontSize: '20px' } }, type === 'individual' ? 'ðŸ‘¤' : 'ðŸ¢'),
                React.createElement('span', { style: { fontWeight: '500' } }, type === 'individual' ? 'Individual' : 'Business Entity')
              )
            )
          )
        ),
        React.createElement('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '16px' } },
          React.createElement(FormInput, { label: form.type === 'individual' ? 'Full Name' : 'Business Name', required: true, value: form.name, onChange: (v) => updateField('name', v), placeholder: form.type === 'individual' ? 'Chaim Gancfried' : 'Gancfried Insurance Brokerage Inc' }),
          form.type === 'individual'
            ? React.createElement(FormInput, { label: 'NPN', required: true, value: form.npn, onChange: (v) => updateField('npn', v), placeholder: '6360803' })
            : React.createElement('div', null,
                React.createElement(FormInput, { label: 'NPN', value: form.npn, onChange: (v) => updateField('npn', v), placeholder: '7382926' }),
                React.createElement(FormInput, { label: 'FEIN', required: true, value: form.fein, onChange: (v) => updateField('fein', v), placeholder: '11-3471664' })
              ),
          React.createElement(FormInput, { label: 'State', required: true, type: 'select', value: form.state, onChange: (v) => updateField('state', v) },
            React.createElement('option', { value: '' }, 'Select State'),
            US_STATES.map(s => React.createElement('option', { key: s, value: s }, s))
          ),
          React.createElement(FormInput, { label: 'License Type', required: true, type: 'select', value: form.licenseType, onChange: (v) => updateField('licenseType', v) },
            React.createElement('option', { value: '' }, 'Select Type'),
            LICENSE_TYPES.map(t => React.createElement('option', { key: t, value: t }, t))
          ),
          React.createElement(FormInput, { label: 'License Number', required: true, value: form.licenseNumber, onChange: (v) => updateField('licenseNumber', v), placeholder: 'CA-LH-2024-001' }),
          React.createElement(FormInput, { label: 'Effective Date', type: 'date', value: form.effectiveDate, onChange: (v) => updateField('effectiveDate', v) }),
          React.createElement(FormInput, { label: 'Expiration Date', required: true, type: 'date', value: form.expirationDate, onChange: (v) => updateField('expirationDate', v) })
        ),
        
        // Document Upload Section
        React.createElement('div', { style: { marginTop: '16px' } },
          React.createElement('label', { style: { display: 'block', marginBottom: '8px', fontWeight: '500', fontSize: '14px', color: '#374151' } }, 'License Document (PDF)'),
          form.documents && form.documents.length > 0
            ? React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', padding: '12px', background: '#f8fafc', borderRadius: '8px', border: '1px solid #e2e8f0' } },
                React.createElement('span', { style: { fontSize: '24px' } }, 'ðŸ“„'),
                React.createElement('a', { 
                  href: form.documents[0].data || form.documents[0].url, 
                  target: '_blank', 
                  onClick: (e) => {
                    // For SharePoint URLs, just open in new tab
                    if (form.documents[0].url && !form.documents[0].data) {
                      e.preventDefault();
                      window.open(form.documents[0].url, '_blank');
                    }
                  },
                  style: { flex: 1, color: '#3b82f6', textDecoration: 'none', fontWeight: '500' } 
                }, form.documents[0].name),
                form.documents[0].url && React.createElement('span', { style: { fontSize: '11px', color: '#10b981', background: '#d1fae5', padding: '2px 8px', borderRadius: '4px' } }, 'âœ“ Saved'),
                React.createElement('button', { onClick: removeDocument, style: { background: '#fee2e2', border: 'none', borderRadius: '6px', padding: '6px 12px', cursor: 'pointer', color: '#dc2626', fontWeight: '500' } }, 'âœ• Remove')
              )
            : React.createElement('div', { 
                onDragOver: handleDragOver,
                onDrop: handleDrop,
                style: { border: '2px dashed #d1d5db', borderRadius: '12px', padding: '32px', textAlign: 'center', cursor: 'pointer', transition: 'all 0.2s', background: '#fafafa' } 
              },
                React.createElement('input', { type: 'file', accept: '.pdf', onChange: handleFileUpload, style: { display: 'none' }, id: 'doc-upload' }),
                React.createElement('label', { htmlFor: 'doc-upload', style: { cursor: 'pointer', display: 'block' } },
                  React.createElement('div', { style: { fontSize: '40px', marginBottom: '12px' } }, 'ðŸ“¤'),
                  React.createElement('div', { style: { color: '#3b82f6', fontWeight: '600', fontSize: '16px', marginBottom: '4px' } }, 'Drag & drop PDF here'),
                  React.createElement('div', { style: { color: '#6b7280', fontSize: '14px' } }, 'or click to browse'),
                  React.createElement('p', { style: { margin: '12px 0 0', fontSize: '12px', color: '#9ca3af' } }, 'PDF files only, max 10MB')
                )
              )
        ),

        React.createElement('div', { style: { marginTop: '16px' } },
          React.createElement(FormInput, { label: 'Notes', type: 'textarea', value: form.notes, onChange: (v) => updateField('notes', v), placeholder: 'Additional notes...' })
        ),
        React.createElement('label', { style: { display: 'flex', alignItems: 'center', gap: '8px', marginTop: '8px', cursor: 'pointer' } },
          React.createElement('input', { type: 'checkbox', checked: form.emailReminders, onChange: (e) => updateField('emailReminders', e.target.checked), style: { width: '18px', height: '18px' } }),
          React.createElement('span', { style: { fontSize: '14px' } }, 'Enable email reminders for expiration')
        ),
        React.createElement('div', { style: { display: 'flex', justifyContent: 'flex-end', gap: '12px', marginTop: '24px', paddingTop: '16px', borderTop: '1px solid #e5e7eb' } },
          React.createElement(Button, { variant: 'secondary', onClick: onCancel, disabled: saving }, 'Cancel'),
          React.createElement(Button, { onClick: handleSubmit, disabled: saving }, saving ? 'Saving...' : (license ? 'Update License' : 'Add License'))
        )
      );
    };

    // ============ CALENDAR VIEW ============
    const CalendarView = ({ licenses }) => {
      const [currentDate, setCurrentDate] = useState(new Date());
      
      const getDaysInMonth = (date) => {
        const year = date.getFullYear();
        const month = date.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const days = [];
        const startPadding = firstDay.getDay();
        
        for (let i = 0; i < startPadding; i++) {
          days.push(null);
        }
        for (let i = 1; i <= lastDay.getDate(); i++) {
          days.push(new Date(year, month, i));
        }
        return days;
      };

      const getEventsForDay = (date) => {
        if (!date) return [];
        const dateStr = date.toISOString().split('T')[0];
        return licenses.filter(l => {
          const expDate = new Date(l.expirationDate).toISOString().split('T')[0];
          return expDate === dateStr;
        });
      };

      const days = getDaysInMonth(currentDate);
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      return React.createElement('div', null,
        React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' } },
          React.createElement('button', { onClick: () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1)), style: { padding: '8px 16px', border: '1px solid #e5e7eb', background: 'white', borderRadius: '6px', cursor: 'pointer' } }, 'â† Prev'),
          React.createElement('h3', { style: { margin: 0, fontSize: '18px' } }, `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`),
          React.createElement('button', { onClick: () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1)), style: { padding: '8px 16px', border: '1px solid #e5e7eb', background: 'white', borderRadius: '6px', cursor: 'pointer' } }, 'Next â†’')
        ),
        React.createElement('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '4px' } },
          ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day =>
            React.createElement('div', { key: day, style: { padding: '12px', textAlign: 'center', fontWeight: '600', fontSize: '12px', color: '#6b7280' } }, day)
          ),
          days.map((date, idx) => {
            const events = getEventsForDay(date);
            const isToday = date && date.getTime() === today.getTime();
            return React.createElement('div', { 
              key: idx, 
              style: { 
                minHeight: '80px', padding: '8px', border: '1px solid #e5e7eb', borderRadius: '6px', 
                background: isToday ? '#eff6ff' : 'white',
                borderColor: isToday ? '#3b82f6' : '#e5e7eb'
              } 
            },
              date && React.createElement('div', { style: { fontWeight: '600', fontSize: '14px', color: '#374151' } }, date.getDate()),
              events.map(event =>
                React.createElement('div', { 
                  key: event.id, 
                  style: { 
                    marginTop: '4px', padding: '2px 6px', 
                    background: event.renewed ? '#dbeafe' : '#fef3c7', 
                    borderRadius: '4px', fontSize: '10px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' 
                  } 
                }, event.name)
              )
            );
          })
        ),
        React.createElement('div', { style: { display: 'flex', gap: '20px', justifyContent: 'center', marginTop: '16px', fontSize: '12px' } },
          React.createElement('span', { style: { color: '#f59e0b' } }, 'ðŸŸ¡ Expiring'),
          React.createElement('span', { style: { color: '#3b82f6' } }, 'ðŸ”µ Renewed')
        )
      );
    };

    // ============ PDF PREVIEW MODAL ============
    const PdfPreviewModal = ({ isOpen, onClose, document, spService }) => {
      const [loading, setLoading] = useState(false);
      const [pdfBlobUrl, setPdfBlobUrl] = useState(null);
      const [error, setError] = useState(null);

      // Load PDF when modal opens
      useEffect(() => {
        if (!isOpen || !document) {
          setPdfBlobUrl(null);
          setError(null);
          return;
        }

        const loadPdf = async () => {
          // If it's base64 data, use it directly
          if (document.data && document.data.startsWith('data:')) {
            setPdfBlobUrl(document.data);
            return;
          }

          // If it's a SharePoint URL, fetch the file
          if (document.url) {
            setLoading(true);
            setError(null);
            try {
              const blobUrl = await spService.getFileForViewing(document.url);
              if (blobUrl) {
                setPdfBlobUrl(blobUrl);
              } else {
                setError('Could not load PDF preview');
              }
            } catch (err) {
              console.error('Error loading PDF:', err);
              setError('Could not load PDF preview');
            } finally {
              setLoading(false);
            }
          }
        };

        loadPdf();

        // Cleanup blob URL when modal closes
        return () => {
          if (pdfBlobUrl && pdfBlobUrl.startsWith('blob:')) {
            URL.revokeObjectURL(pdfBlobUrl);
          }
        };
      }, [isOpen, document]);

      if (!isOpen || !document) return null;
      
      const handleDownload = () => {
        if (pdfBlobUrl) {
          const link = window.document.createElement('a');
          link.href = pdfBlobUrl;
          link.download = document.name || 'license-document.pdf';
          window.document.body.appendChild(link);
          link.click();
          window.document.body.removeChild(link);
        } else if (document.url) {
          window.open(document.url, '_blank');
        }
      };

      const handleOpenInSharePoint = () => {
        window.open(document.url, '_blank');
      };

      return React.createElement('div', { 
        style: { position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.8)', backdropFilter: 'blur(4px)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' }, 
        onClick: onClose 
      },
        React.createElement('div', { 
          style: { background: 'white', borderRadius: '16px', width: '100%', maxWidth: '900px', height: '90vh', display: 'flex', flexDirection: 'column', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.5)' }, 
          onClick: (e) => e.stopPropagation() 
        },
          // Header
          React.createElement('div', { style: { padding: '16px 24px', borderBottom: '1px solid #e5e7eb', display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: '#f8fafc', borderRadius: '16px 16px 0 0' } },
            React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '12px' } },
              React.createElement('span', { style: { fontSize: '24px' } }, 'ðŸ“„'),
              React.createElement('span', { style: { fontWeight: '600', fontSize: '16px', color: '#111827', maxWidth: '400px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, document.name || 'License Document')
            ),
            React.createElement('div', { style: { display: 'flex', gap: '8px' } },
              document.url && React.createElement('button', { 
                onClick: handleOpenInSharePoint, 
                style: { background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', color: 'white', border: 'none', padding: '8px 16px', borderRadius: '8px', cursor: 'pointer', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '6px', fontSize: '13px' } 
              }, 'ðŸ”— SharePoint'),
              React.createElement('button', { 
                onClick: handleDownload, 
                disabled: loading,
                style: { background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', color: 'white', border: 'none', padding: '8px 16px', borderRadius: '8px', cursor: loading ? 'not-allowed' : 'pointer', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '6px', opacity: loading ? 0.6 : 1, fontSize: '13px' } 
              }, 'â¬‡ï¸ Download'),
              React.createElement('button', { 
                onClick: onClose, 
                style: { background: '#f1f5f9', border: 'none', width: '36px', height: '36px', borderRadius: '8px', fontSize: '20px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' } 
              }, 'âœ•')
            )
          ),
          // PDF Viewer
          React.createElement('div', { style: { flex: 1, padding: '16px', background: '#374151', overflow: 'hidden', display: 'flex', alignItems: 'center', justifyContent: 'center' } },
            loading 
              ? React.createElement('div', { style: { textAlign: 'center', color: 'white' } },
                  React.createElement('div', { style: { width: '48px', height: '48px', border: '4px solid rgba(255,255,255,0.2)', borderTopColor: 'white', borderRadius: '50%', animation: 'spin 1s linear infinite', margin: '0 auto 16px' } }),
                  React.createElement('p', null, 'Loading PDF...'),
                  React.createElement('style', null, '@keyframes spin { to { transform: rotate(360deg); } }')
                )
              : error
                ? React.createElement('div', { style: { textAlign: 'center', color: 'white' } },
                    React.createElement('div', { style: { fontSize: '48px', marginBottom: '16px' } }, 'âš ï¸'),
                    React.createElement('p', { style: { marginBottom: '16px' } }, error),
                    React.createElement('button', { 
                      onClick: handleOpenInSharePoint, 
                      style: { background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', color: 'white', border: 'none', padding: '12px 24px', borderRadius: '8px', cursor: 'pointer', fontWeight: '600' } 
                    }, 'ðŸ”— Open in SharePoint Instead')
                  )
                : pdfBlobUrl
                  ? React.createElement('iframe', { 
                      src: pdfBlobUrl,
                      style: { width: '100%', height: '100%', border: 'none', borderRadius: '8px', background: 'white' },
                      title: 'PDF Preview'
                    })
                  : React.createElement('div', { style: { textAlign: 'center', color: 'white' } },
                      React.createElement('div', { style: { fontSize: '48px', marginBottom: '16px' } }, 'ðŸ“„'),
                      React.createElement('p', null, 'No preview available')
                    )
          )
        )
      );
    };

    // ============ LOGIN SCREEN ============
    const LoginScreen = ({ onLogin, loading }) => {
      return React.createElement('div', { style: { minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'linear-gradient(135deg, #0f172a 0%, #1e293b 100%)' } },
        React.createElement('div', { style: { background: 'white', padding: '48px', borderRadius: '16px', textAlign: 'center', maxWidth: '400px', width: '100%', margin: '20px', boxShadow: '0 25px 50px -12px rgba(0,0,0,0.5)' } },
          React.createElement('img', { src: LOGO_FULL, alt: 'Gancfried Insurance', style: { width: '200px', marginBottom: '24px' } }),
          React.createElement('h1', { style: { margin: '0 0 8px', fontSize: '24px', color: '#111827' } }, 'Producer License Manager'),
          React.createElement('p', { style: { margin: '0 0 32px', color: '#6b7280' } }, 'Sign in with your Microsoft account to continue'),
          React.createElement('button', {
            onClick: onLogin,
            disabled: loading,
            style: { 
              width: '100%', padding: '14px 24px', background: '#0078d4', color: 'white', border: 'none', 
              borderRadius: '8px', fontSize: '16px', fontWeight: '600', cursor: loading ? 'not-allowed' : 'pointer',
              display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '12px', opacity: loading ? 0.7 : 1
            }
          },
            React.createElement('svg', { width: '20', height: '20', viewBox: '0 0 21 21' },
              React.createElement('rect', { x: '1', y: '1', width: '9', height: '9', fill: '#f25022' }),
              React.createElement('rect', { x: '11', y: '1', width: '9', height: '9', fill: '#7fba00' }),
              React.createElement('rect', { x: '1', y: '11', width: '9', height: '9', fill: '#00a4ef' }),
              React.createElement('rect', { x: '11', y: '11', width: '9', height: '9', fill: '#ffb900' })
            ),
            loading ? 'Signing in...' : 'Sign in with Microsoft'
          ),
          React.createElement('p', { style: { margin: '24px 0 0', fontSize: '12px', color: '#9ca3af' } }, 'Data stored securely in SharePoint')
        )
      );
    };

    // ============ MAIN APPLICATION ============
    function ProducerLicenseManager() {
      const [user, setUser] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);
      const [licenses, setLicenses] = useState([]);
      const [loading, setLoading] = useState(false);
      const [saving, setSaving] = useState(false);
      const [error, setError] = useState(null);
      const [showAddModal, setShowAddModal] = useState(false);
      const [editingLicense, setEditingLicense] = useState(null);
      const [view, setView] = useState('list');
      const [filter, setFilter] = useState('all');
      const [statusFilter, setStatusFilter] = useState('all');
      const [stateFilter, setStateFilter] = useState('all');
      const [searchTerm, setSearchTerm] = useState('');
      const [sortConfig, setSortConfig] = useState({ key: 'expirationDate', direction: 'asc' });
      const [previewDocument, setPreviewDocument] = useState(null);

      // Check authentication on mount
      useEffect(() => {
        const checkAuth = async () => {
          try {
            await msalInstance.initialize();
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
              setUser(accounts[0]);
            }
          } catch (err) {
            console.error('Auth check failed:', err);
          } finally {
            setAuthLoading(false);
          }
        };
        checkAuth();
      }, []);

      // Load licenses when user is authenticated
      useEffect(() => {
        if (user) {
          loadLicenses();
        }
      }, [user]);

      const handleLogin = async () => {
        setAuthLoading(true);
        try {
          const response = await msalInstance.loginPopup(loginRequest);
          setUser(response.account);
        } catch (err) {
          console.error('Login failed:', err);
          setError('Login failed: ' + err.message);
        } finally {
          setAuthLoading(false);
        }
      };

      const handleLogout = async () => {
        await msalInstance.logoutPopup();
        setUser(null);
        setLicenses([]);
      };

      const loadLicenses = async () => {
        setLoading(true);
        setError(null);
        try {
          const data = await spService.getLicenses();
          setLicenses(data);
        } catch (err) {
          console.error('Failed to load licenses:', err);
          setError('Failed to load licenses: ' + err.message);
        } finally {
          setLoading(false);
        }
      };

      const handleSaveLicense = async (licenseData) => {
        setSaving(true);
        try {
          if (editingLicense) {
            const updated = await spService.updateLicense({ ...licenseData, id: editingLicense.id });
            setLicenses(prev => prev.map(l => l.id === updated.id ? updated : l));
          } else {
            const created = await spService.createLicense(licenseData);
            setLicenses(prev => [...prev, created]);
          }
          setShowAddModal(false);
          setEditingLicense(null);
        } catch (err) {
          alert('Failed to save: ' + err.message);
        } finally {
          setSaving(false);
        }
      };

      const handleDeleteLicense = async (id) => {
        if (!confirm('Are you sure you want to delete this license?')) return;
        try {
          await spService.deleteLicense(id);
          setLicenses(prev => prev.filter(l => l.id !== id));
        } catch (err) {
          alert('Failed to delete: ' + err.message);
        }
      };

      const handleMarkRenewed = async (id) => {
        const license = licenses.find(l => l.id === id);
        if (license) {
          try {
            const updated = await spService.updateLicense({ ...license, renewed: true });
            setLicenses(prev => prev.map(l => l.id === id ? { ...l, renewed: true } : l));
          } catch (err) {
            alert('Failed to update: ' + err.message);
          }
        }
      };

      const handleSort = (key) => {
        setSortConfig(prev => ({
          key,
          direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
        }));
      };

      const exportToExcel = () => {
        const headers = ['Type', 'Name', 'NPN/FEIN', 'State', 'License Type', 'License #', 'Effective', 'Expires', 'Status'];
        const rows = filteredLicenses.map(l => [
          l.type, l.name, l.type === 'individual' ? l.npn : l.fein, l.state, l.licenseType,
          l.licenseNumber, l.effectiveDate, l.expirationDate, l.renewed ? 'Renewed' : getStatus(l.expirationDate)
        ]);
        const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'licenses_export.csv';
        a.click();
      };

      // Calculate stats and filter licenses
      const stats = useMemo(() => {
        const active = licenses.filter(l => !l.renewed && getStatus(l.expirationDate) === 'active').length;
        const expiring = licenses.filter(l => !l.renewed && getStatus(l.expirationDate) === 'expiring').length;
        const expired = licenses.filter(l => !l.renewed && getStatus(l.expirationDate) === 'expired').length;
        const renewed = licenses.filter(l => l.renewed).length;
        return { total: licenses.length, active, expiring, expired, renewed };
      }, [licenses]);

      const filteredLicenses = useMemo(() => {
        let result = [...licenses];
        
        if (filter !== 'all') result = result.filter(l => l.type === filter);
        if (statusFilter !== 'all') {
          if (statusFilter === 'renewed') {
            result = result.filter(l => l.renewed);
          } else {
            result = result.filter(l => !l.renewed && getStatus(l.expirationDate) === statusFilter);
          }
        }
        if (stateFilter !== 'all') result = result.filter(l => l.state === stateFilter);
        if (searchTerm) {
          const term = searchTerm.toLowerCase();
          result = result.filter(l => 
            l.name.toLowerCase().includes(term) ||
            l.licenseNumber.toLowerCase().includes(term) ||
            l.npn?.toLowerCase().includes(term) ||
            l.fein?.toLowerCase().includes(term)
          );
        }

        result.sort((a, b) => {
          let aVal = a[sortConfig.key];
          let bVal = b[sortConfig.key];
          if (sortConfig.key === 'expirationDate' || sortConfig.key === 'effectiveDate') {
            aVal = new Date(aVal || 0);
            bVal = new Date(bVal || 0);
          }
          if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
          if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
          return 0;
        });

        return result;
      }, [licenses, filter, statusFilter, stateFilter, searchTerm, sortConfig]);

      // Show login screen if not authenticated
      if (authLoading) {
        return React.createElement('div', { style: { minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center' } },
          React.createElement('div', { style: { textAlign: 'center' } },
            React.createElement('div', { style: { width: '48px', height: '48px', border: '4px solid #e2e8f0', borderTopColor: '#3b82f6', borderRadius: '50%', animation: 'spin 1s linear infinite', margin: '0 auto 16px' } }),
            React.createElement('p', null, 'Loading...')
          ),
          React.createElement('style', null, '@keyframes spin { to { transform: rotate(360deg); } }')
        );
      }

      if (!user) {
        return React.createElement(LoginScreen, { onLogin: handleLogin, loading: authLoading });
      }

      // Main application
      return React.createElement('div', { style: { minHeight: '100vh', padding: '24px', maxWidth: '1400px', margin: '0 auto' } },
        // Header
        React.createElement('header', { style: { background: 'linear-gradient(135deg, #0f172a 0%, #1e293b 100%)', color: 'white', padding: '24px 32px', borderRadius: '12px', marginBottom: '24px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '16px' } },
          React.createElement('div', null,
            React.createElement('h1', { style: { margin: 0, fontSize: '24px', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '12px' } }, 
              React.createElement('img', { src: LOGO_ICON, alt: 'GIB', style: { height: '36px' } }),
              'Producer License Manager'
            ),
            React.createElement('p', { style: { margin: '4px 0 0', opacity: 0.9, fontSize: '14px' } }, 'Track and manage individual & business entity licenses')
          ),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '16px' } },
            React.createElement('span', { style: { fontSize: '14px', opacity: 0.9 } }, `Welcome, ${user.name || user.username}`),
            React.createElement(Button, { onClick: () => setShowAddModal(true), style: { background: '#3b82f6' } }, '+ Add License'),
            React.createElement('button', { onClick: handleLogout, style: { padding: '8px 16px', background: 'rgba(255,255,255,0.1)', color: 'white', border: '1px solid rgba(255,255,255,0.2)', borderRadius: '8px', cursor: 'pointer', fontSize: '14px' } }, 'Sign Out')
          )
        ),

        // Error message
        error && React.createElement('div', { style: { background: '#fee2e2', color: '#991b1b', padding: '16px', borderRadius: '8px', marginBottom: '24px' } },
          error,
          React.createElement('button', { onClick: loadLicenses, style: { marginLeft: '16px', padding: '4px 12px', background: 'white', border: '1px solid #991b1b', borderRadius: '4px', cursor: 'pointer' } }, 'Retry')
        ),

        // Stats Grid
        React.createElement('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: '16px', marginBottom: '24px' } },
          [
            { label: 'Total', value: stats.total, color: '#8b5cf6', icon: 'ðŸ“‹' },
            { label: 'Active', value: stats.active, color: '#10b981', icon: 'âœ…' },
            { label: 'Expiring', value: stats.expiring, color: '#f59e0b', icon: 'âš ï¸' },
            { label: 'Expired', value: stats.expired, color: '#ef4444', icon: 'âŒ' },
            { label: 'Renewed', value: stats.renewed, color: '#3b82f6', icon: 'ðŸ”„' }
          ].map(stat =>
            React.createElement('div', { key: stat.label, style: { background: 'white', borderRadius: '12px', padding: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', borderLeft: `4px solid ${stat.color}` } },
              React.createElement('div', null,
                React.createElement('p', { style: { margin: 0, fontSize: '12px', color: '#64748b', textTransform: 'uppercase', letterSpacing: '0.5px' } }, stat.label),
                React.createElement('p', { style: { margin: '4px 0 0', fontSize: '32px', fontWeight: '700', color: stat.color } }, loading ? '-' : stat.value)
              ),
              React.createElement('span', { style: { fontSize: '32px', opacity: 0.8 } }, stat.icon)
            )
          )
        ),

        // Filters
        React.createElement('div', { style: { background: 'white', borderRadius: '12px', padding: '16px 20px', marginBottom: '24px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '16px' } },
          React.createElement('div', { style: { display: 'flex', gap: '8px' } },
            ['all', 'individual', 'business'].map(f =>
              React.createElement('button', { key: f, onClick: () => setFilter(f), style: { padding: '8px 16px', border: '1px solid #e2e8f0', background: filter === f ? '#0f172a' : 'white', color: filter === f ? 'white' : '#374151', borderRadius: '8px', cursor: 'pointer', fontSize: '14px' } },
                f === 'all' ? 'All' : f === 'individual' ? 'ðŸ‘¤ Individual' : 'ðŸ¢ Business'
              )
            )
          ),
          React.createElement('div', { style: { display: 'flex', gap: '12px', alignItems: 'center', flexWrap: 'wrap' } },
            React.createElement('input', { type: 'text', placeholder: 'ðŸ” Search...', value: searchTerm, onChange: (e) => setSearchTerm(e.target.value), style: { padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '14px', minWidth: '200px' } }),
            React.createElement('select', { value: statusFilter, onChange: (e) => setStatusFilter(e.target.value), style: { padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '14px' } },
              React.createElement('option', { value: 'all' }, 'All Status'),
              React.createElement('option', { value: 'active' }, 'Active'),
              React.createElement('option', { value: 'expiring' }, 'Expiring'),
              React.createElement('option', { value: 'expired' }, 'Expired'),
              React.createElement('option', { value: 'renewed' }, 'Renewed')
            ),
            React.createElement('select', { value: stateFilter, onChange: (e) => setStateFilter(e.target.value), style: { padding: '8px 12px', border: '1px solid #e2e8f0', borderRadius: '8px', fontSize: '14px' } },
              React.createElement('option', { value: 'all' }, 'All States'),
              US_STATES.map(s => React.createElement('option', { key: s, value: s }, s))
            ),
            React.createElement('div', { style: { display: 'flex', border: '1px solid #e2e8f0', borderRadius: '8px', overflow: 'hidden' } },
              React.createElement('button', { onClick: () => setView('list'), style: { padding: '8px 12px', border: 'none', background: view === 'list' ? '#3b82f6' : 'white', color: view === 'list' ? 'white' : '#374151', cursor: 'pointer' } }, 'ðŸ“‹'),
              React.createElement('button', { onClick: () => setView('calendar'), style: { padding: '8px 12px', border: 'none', borderLeft: '1px solid #e2e8f0', background: view === 'calendar' ? '#3b82f6' : 'white', color: view === 'calendar' ? 'white' : '#374151', cursor: 'pointer' } }, 'ðŸ“…')
            ),
            React.createElement(Button, { variant: 'success', onClick: exportToExcel, style: { padding: '8px 16px' } }, 'ðŸ“Š Export')
          )
        ),

        // Loading state
        loading ? React.createElement('div', { style: { background: 'white', borderRadius: '12px', padding: '60px', textAlign: 'center' } },
          React.createElement('div', { style: { width: '48px', height: '48px', border: '4px solid #e2e8f0', borderTopColor: '#3b82f6', borderRadius: '50%', animation: 'spin 1s linear infinite', margin: '0 auto 16px' } }),
          React.createElement('p', { style: { color: '#6b7280' } }, 'Loading licenses...'),
          React.createElement('style', null, '@keyframes spin { to { transform: rotate(360deg); } }')
        ) :

        // Table or Calendar
        React.createElement('div', { style: { background: 'white', borderRadius: '12px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', overflow: 'hidden' } },
          view === 'calendar'
            ? React.createElement('div', { style: { padding: '24px' } }, React.createElement(CalendarView, { licenses }))
            : React.createElement('div', { style: { overflowX: 'auto' } },
                React.createElement('table', { style: { width: '100%', borderCollapse: 'collapse' } },
                  React.createElement('thead', null,
                    React.createElement('tr', { style: { background: '#f9fafb' } },
                      [{ key: 'type', label: 'Type' }, { key: 'name', label: 'Name' }, { key: 'state', label: 'State' }, { key: 'licenseType', label: 'License Type' }, { key: 'licenseNumber', label: 'License #' }, { key: 'effectiveDate', label: 'Effective' }, { key: 'expirationDate', label: 'Expires' }, { key: 'status', label: 'Status' }, { key: 'actions', label: 'Actions' }].map(col =>
                        React.createElement('th', { key: col.key, onClick: () => col.key !== 'actions' && col.key !== 'status' && handleSort(col.key), style: { padding: '14px 16px', textAlign: 'left', fontSize: '12px', fontWeight: '600', color: '#6b7280', textTransform: 'uppercase', letterSpacing: '0.5px', cursor: col.key !== 'actions' && col.key !== 'status' ? 'pointer' : 'default', borderBottom: '1px solid #e5e7eb', whiteSpace: 'nowrap' } },
                          col.label, sortConfig.key === col.key && (sortConfig.direction === 'asc' ? ' â†‘' : ' â†“')
                        )
                      )
                    )
                  ),
                  React.createElement('tbody', null,
                    filteredLicenses.length === 0
                      ? React.createElement('tr', null,
                          React.createElement('td', { colSpan: 9, style: { padding: '48px', textAlign: 'center', color: '#6b7280' } },
                            React.createElement('div', { style: { fontSize: '48px', marginBottom: '16px' } }, 'ðŸ“­'),
                            React.createElement('p', { style: { margin: 0, fontWeight: '500' } }, 'No licenses found')
                          )
                        )
                      : filteredLicenses.map((license, idx) => {
                          const status = license.renewed ? 'renewed' : getStatus(license.expirationDate);
                          const daysLeft = calculateDaysUntilExpiration(license.expirationDate);
                          return React.createElement('tr', { key: license.id, style: { background: idx % 2 === 0 ? 'white' : '#f9fafb', borderBottom: '1px solid #e5e7eb' } },
                            React.createElement('td', { style: { padding: '14px 16px' } },
                              React.createElement('span', { style: { background: license.type === 'individual' ? '#dbeafe' : '#fef3c7', padding: '4px 10px', borderRadius: '6px', fontSize: '12px', fontWeight: '500' } },
                                license.type === 'individual' ? 'ðŸ‘¤ Individual' : 'ðŸ¢ Business'
                              )
                            ),
                            React.createElement('td', { style: { padding: '14px 16px' } },
                              React.createElement('div', { style: { fontWeight: '500', color: '#111827' } }, license.name),
                              React.createElement('div', { style: { fontSize: '12px', color: '#6b7280' } }, license.type === 'individual' ? 'NPN: ' + license.npn : 'FEIN: ' + license.fein)
                            ),
                            React.createElement('td', { style: { padding: '14px 16px', fontWeight: '500' } }, license.state),
                            React.createElement('td', { style: { padding: '14px 16px', fontSize: '13px' } }, license.licenseType),
                            React.createElement('td', { style: { padding: '14px 16px', fontSize: '13px', fontFamily: 'monospace' } }, license.licenseNumber),
                            React.createElement('td', { style: { padding: '14px 16px', fontSize: '13px' } }, formatDate(license.effectiveDate)),
                            React.createElement('td', { style: { padding: '14px 16px' } },
                              React.createElement('div', { style: { fontSize: '13px' } }, formatDate(license.expirationDate)),
                              !license.renewed && React.createElement('div', { style: { fontSize: '11px', color: daysLeft <= 0 ? '#dc2626' : daysLeft <= 30 ? '#d97706' : '#059669', fontWeight: '500' } },
                                daysLeft <= 0 ? Math.abs(daysLeft) + ' days overdue' : daysLeft + ' days left'
                              )
                            ),
                            React.createElement('td', { style: { padding: '14px 16px' } }, React.createElement(StatusBadge, { status })),
                            React.createElement('td', { style: { padding: '14px 16px' } },
                              React.createElement('div', { style: { display: 'flex', gap: '8px' } },
                                license.documents && license.documents.length > 0 && React.createElement('button', { onClick: () => setPreviewDocument(license.documents[0]), title: 'View Document', style: { background: '#f3e8ff', border: 'none', borderRadius: '6px', padding: '6px 10px', cursor: 'pointer', fontSize: '14px' } }, 'ðŸ“„'),
                                React.createElement('button', { onClick: () => { setEditingLicense(license); setShowAddModal(true); }, title: 'Edit', style: { background: '#dbeafe', border: 'none', borderRadius: '6px', padding: '6px 10px', cursor: 'pointer', fontSize: '14px' } }, 'âœï¸'),
                                !license.renewed && React.createElement('button', { onClick: () => handleMarkRenewed(license.id), title: 'Mark Renewed', style: { background: '#d1fae5', border: 'none', borderRadius: '6px', padding: '6px 10px', cursor: 'pointer', fontSize: '14px' } }, 'âœ…'),
                                React.createElement('button', { onClick: () => handleDeleteLicense(license.id), title: 'Delete', style: { background: '#fee2e2', border: 'none', borderRadius: '6px', padding: '6px 10px', cursor: 'pointer', fontSize: '14px' } }, 'ðŸ—‘ï¸')
                              )
                            )
                          );
                        })
                  )
                )
              )
        ),

        // Expiring Alert
        stats.expiring > 0 && React.createElement('div', { style: { marginTop: '24px', background: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)', borderRadius: '12px', padding: '20px 24px', border: '1px solid #f59e0b' } },
          React.createElement('h3', { style: { margin: '0 0 12px', fontSize: '16px', color: '#92400e' } }, 'âš ï¸ Licenses Expiring Within 30 Days'),
          React.createElement('div', { style: { display: 'flex', flexWrap: 'wrap', gap: '8px' } },
            licenses.filter(l => !l.renewed && getStatus(l.expirationDate) === 'expiring').map(l =>
              React.createElement('div', { key: l.id, style: { background: 'white', padding: '8px 12px', borderRadius: '6px', fontSize: '13px', display: 'flex', alignItems: 'center', gap: '8px' } },
                l.type === 'individual' ? 'ðŸ‘¤' : 'ðŸ¢',
                React.createElement('strong', null, l.name),
                React.createElement('span', { style: { color: '#6b7280' } }, '(' + l.state + ')'),
                React.createElement('span', { style: { color: '#d97706', fontWeight: '600' } }, calculateDaysUntilExpiration(l.expirationDate) + ' days')
              )
            )
          )
        ),

        // Add/Edit Modal
        React.createElement(Modal, { isOpen: showAddModal, onClose: () => { setShowAddModal(false); setEditingLicense(null); }, title: editingLicense ? 'âœï¸ Edit License' : 'âž• Add New License', size: 'large' },
          React.createElement(LicenseForm, { license: editingLicense, onSave: handleSaveLicense, onCancel: () => { setShowAddModal(false); setEditingLicense(null); }, saving: saving })
        ),

        // PDF Preview Modal
        React.createElement(PdfPreviewModal, { isOpen: !!previewDocument, onClose: () => setPreviewDocument(null), document: previewDocument, spService: spService }),

        // Footer
        React.createElement('footer', { style: { textAlign: 'center', padding: '24px', color: '#6b7280', fontSize: '13px' } }, 'ðŸ”’ Data stored in SharePoint')
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(ProducerLicenseManager));
  </script>
</body>
</html>
